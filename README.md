let ingested_lookback = 1h;
let generated_lookback = 3h;
union(
W3CIISLog
| where TimeGenerated between (ago(generated_lookback) .. now()) and ingestion_time() > ago(ingested_lookback)
| where csUserAgent contains '${jndi:ldap'
| extend Callback = extract(@'ldap:\/\/([a-zA-Z0-9\._\\]*):?\d*?\/', 1, csUserAgent)
| extend CallbackIP = iff(isnotempty(parse_ipv4(Callback)), Callback, '')
| summarize count(), DstIPs=make_set(sIP), SrcIPs=make_set(cIP), StatusCodes=make_set(scStatus), Methods=make_set(csMethod), UserAgents=make_set(csUserAgent,5), SiteNames=make_set(sSiteName) by Callback, CallbackIP
)
| project DstIPs, SrcIPs, StatusCodes, Methods, UserAgents, SiteNames, Callback, CallbackIP
